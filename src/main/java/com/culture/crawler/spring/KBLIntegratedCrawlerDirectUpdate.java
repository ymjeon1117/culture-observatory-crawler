package com.culture.crawler.spring;

import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.math.BigDecimal;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.attribute.FileTime;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Types;
import java.time.Duration;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.DateUtil;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.Select;
import org.openqa.selenium.support.ui.WebDriverWait;

import com.culture.util.LogUtil;

public class KBLIntegratedCrawlerDirectUpdate {
    public static void main(String[] args) {
        try {
            // 1. Í≤ΩÍ∏∞ÏùºÏ†ï ÌÅ¨Î°§ÎßÅ Î∞è DB Ï†ÄÏû• ‚Üí ÎßàÏßÄÎßâ KBL Í∏∞Ï§ÄÏùºÎì§ Î¶¨ÌÑ¥
            Map<String, LocalDate> result = runMatchScheduleCrawlerAndInsertToDB();
            LocalDate matchInfoBaseDate = result.get("latestMatchDateColct");  // Îß∑ÏπòÏù∏Ìè¨ Í∏∞Ï§ÄÏùº
            LocalDate crowdBaseDate = result.get("latestMatchDateKblCd");      // Í¥ÄÏ§ëÏàò Í∏∞Ï§ÄÏùº

            // 2. Í¥ÄÏ§ëÏàò ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú
            Path excelFile = runCrowdExcelDownload();

            // 3. Í¥ÄÏ§ëÏàò Excel ‚Üí DB ÏÇΩÏûÖ + ÌÜµÌï© ÌÖåÏù¥Î∏î ÏÇΩÏûÖ
            if (excelFile != null && result != null) {
                updateCrowdFromExcel(
                    excelFile,
                    crowdBaseDate.format(DateTimeFormatter.ofPattern("yyyyMMdd"))
                );

                insertToMatchInfoTable(matchInfoBaseDate);

            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	
	public static Map<String, LocalDate> runMatchScheduleCrawlerAndInsertToDB() throws Exception {
		
	    System.setProperty("webdriver.chrome.driver", "C:\\chromedriver\\chromedriver.exe");

	    ChromeOptions options = new ChromeOptions();
	    options.addArguments("--remote-allow-origins=*");
	    WebDriver driver = new ChromeDriver(options);
	    WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(10));

	    String latestMatchDateColct = "20230101";
	    String latestMatchDateKblSc = "20230101";
	    String latestMatchDateKblCd = "20230101";

	    // DB Ïó∞Í≤∞
	    try (Connection conn = DriverManager.getConnection(
	            "jdbc:mysql://localhost:3306/culture_crawler_db?serverTimezone=Asia/Seoul", "root", "1234")) {
	        conn.setAutoCommit(false);
	        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
	        LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_SC", "STARTED", null, null, null, "", today);

	        // Í∏∞Ï§ÄÏùº Ï°∞Ìöå - colct_sports_match_info
	        try (PreparedStatement stmt = conn.prepareStatement(
	                "SELECT MAX(MATCH_DE) FROM colct_sports_match_info WHERE GRP_NM = 'KBL'")) {
	            ResultSet rs = stmt.executeQuery();
	            if (rs.next() && rs.getString(1) != null) {
	                latestMatchDateColct = rs.getString(1);
	            }
	            rs.close();
	        }

	        // Í∏∞Ï§ÄÏùº Ï°∞Ìöå - colct_sports_match_info_KBL_SC
	        try (PreparedStatement stmt = conn.prepareStatement(
	                "SELECT MAX(MATCH_DE) FROM colct_sports_match_info_KBL_SC")) {
	            ResultSet rs = stmt.executeQuery();
	            if (rs.next() && rs.getString(1) != null) {
	                latestMatchDateKblSc = rs.getString(1);
	            }
	            rs.close();
	        }
	        

	     // Í∏∞Ï§ÄÏùº Ï°∞Ìöå - colct_sports_match_info_KBL_CD
	     try (PreparedStatement stmt = conn.prepareStatement(
	             "SELECT MAX(MATCH_DE) FROM colct_sports_match_info_KBL_CD")) {
	         ResultSet rs = stmt.executeQuery();
	         if (rs.next() && rs.getString(1) != null) {
	             latestMatchDateKblCd = rs.getString(1);
	         }
	         rs.close();
	     }

	     System.out.println("üìå KblCd ÌÖåÏù¥Î∏î ÎßàÏßÄÎßâ Ï†ÄÏû•Îêú KBL Í≤ΩÍ∏∞Ïùº: " + latestMatchDateKblCd);
         System.out.println("üìå KblSc ÌÖåÏù¥Î∏î ÎßàÏßÄÎßâ Ï†ÄÏû•Îêú KBL Í≤ΩÍ∏∞Ïùº: " + latestMatchDateColct);
            System.out.println("üìå Îß§Ïπò ÌÖåÏù¥Î∏î ÎßàÏßÄÎßâ Ï†ÄÏû•Îêú KBL Í≤ΩÍ∏∞Ïùº: " + latestMatchDateKblSc);



	        driver.get("https://www.kbl.or.kr/match/schedule?type=SCHEDULE");
	        driver.manage().window().maximize();
	        Thread.sleep(3000);

	        String[] currentMonthParts = driver.findElement(By.cssSelector(
	                "#root > main > div > div.contents > div.filter-wrap > div > ul > li:nth-child(2) > p"))
	                .getText().trim().split("\\.");
	        int currentYear = Integer.parseInt(currentMonthParts[0].trim());
	        int currentMonth = Integer.parseInt(currentMonthParts[1].trim());

	        // Îçî Í≥ºÍ±∞ Í∏∞Ï§ÄÏùºÎ°ú ÏàòÏßëÍ∏∞Ï§Ä ÏÑ§Ï†ï
	        String baseDate = (latestMatchDateColct.compareTo(latestMatchDateKblSc) <= 0)
	                          ? latestMatchDateColct : latestMatchDateKblSc;
	        LocalDate latestDate = LocalDate.parse(baseDate, DateTimeFormatter.ofPattern("yyyyMMdd"));

	        System.out.println("üìå ÎßàÏßÄÎßâ Í≤ΩÍ∏∞Ïùº: " + latestDate);
	        
	        // ÌÅ¨Î°§ÎßÅ ÏãúÏûëÏùº Í≤∞Ï†ï
	        LocalDate startDate = LocalDate.of(currentYear, currentMonth, 1);
	        if (startDate.isBefore(latestDate.plusDays(1))) {
	            startDate = latestDate.plusDays(1);
	        }

	        List<Map<String, String>> parsedList = new ArrayList<>();

	        while (!startDate.isBefore(latestDate.minusMonths(1))) {
	            System.out.println("[INFO] ÏàòÏßë Ï§ë: " + startDate.getYear() + ". " + startDate.getMonthValue());

	            List<WebElement> gameLists = driver.findElements(By.cssSelector(".cont-box .game-schedule-list"));
	            for (WebElement gameList : gameLists) {
	                String matchDe = gameList.getAttribute("id").replace("game-", "").trim();
	                if (matchDe.compareTo(baseDate) < 0) continue;

	                String baseYear = matchDe.substring(0, 4);
	                String baseMonth = matchDe.substring(4, 6);
	                String baseDay = matchDe.substring(6, 8);

	                List<WebElement> items = gameList.findElements(By.cssSelector("ul > li"));
	                for (WebElement item : items) {
	                    if (item.findElements(By.cssSelector("div.sub")).isEmpty()) continue;

	                    WebElement desc = item.findElement(By.cssSelector("div.sub > div.desc"));
	                    String gameType = desc.findElement(By.cssSelector("span.label")).getText().trim();
	                    String stadium = desc.findElements(By.cssSelector("ul > li")).get(1).getText().trim();

	                    List<WebElement> teams = item.findElements(By.cssSelector("div.info ul.versus > li"));
	                    if (teams.size() != 2) continue;

	                    String homeTeam = normalizeTeamName(teams.get(0).findElements(By.tagName("p")).get(0).getText().trim());
	                    String awayTeam = normalizeTeamName(teams.get(1).findElements(By.tagName("p")).get(0).getText().trim());

	                    Map<String, String> row = new HashMap<>();
	                    row.put("matchDe", matchDe);
	                    row.put("baseYear", baseYear);
	                    row.put("baseMonth", baseMonth);
	                    row.put("baseDay", baseDay);
	                    row.put("gameType", gameType);
	                    row.put("stadium", stadium);
	                    row.put("homeTeam", homeTeam);
	                    row.put("awayTeam", awayTeam);
	                    parsedList.add(row);
	                }
	            }

	            startDate = startDate.minusMonths(1);
	            driver.findElement(By.cssSelector(".filter-wrap ul.date li:nth-child(1) button")).click();
	            Thread.sleep(2000);
	        }
	        final String finalColctDate = latestMatchDateColct;
	        final String finalKblScDate = latestMatchDateKblSc;

	        List<Map<String, String>> listForColct = parsedList.stream()
	            .filter(row -> row.get("matchDe").compareTo(finalColctDate) >= 0)
	            .collect(Collectors.toList());

	        List<Map<String, String>> listForKblSc = parsedList.stream()
	            .filter(row -> row.get("matchDe").compareTo(finalKblScDate) >= 0)
	            .collect(Collectors.toList());


	        // ‚úÖ Ï≤´ Î≤àÏß∏ ÌÖåÏù¥Î∏î Ï≤òÎ¶¨	        
	        int totalKblSc = listForKblSc.size();
	        int insertedKblSc = 0;
	        // ‚úÖ ÏÇΩÏûÖ Ï†Ñ ÏÇ≠Ï†ú - colct_sports_match_info_KBL_SC
	        try (PreparedStatement deleteStmt = conn.prepareStatement(
	                "DELETE FROM colct_sports_match_info_KBL_SC WHERE MATCH_DE = ?")) {
	            deleteStmt.setString(1, latestMatchDateKblSc);
	            deleteStmt.executeUpdate();
	        }
	        try (
	            PreparedStatement insertStmtKblSc = conn.prepareStatement("""
	                INSERT INTO colct_sports_match_info_KBL_SC (
	                    MATCH_DE, LEA_NM, STDM_NM, HOME_TEAM_NM, AWAY_TEAM_NM
	                ) VALUES (?, ?, ?, ?, ?)
	            """)
	        ) {
	            conn.setAutoCommit(false);
	            for (Map<String, String> row : listForKblSc) {
	                insertStmtKblSc.setString(1, row.get("matchDe"));
	                insertStmtKblSc.setString(2, row.get("gameType"));
	                insertStmtKblSc.setString(3, row.get("stadium"));
	                insertStmtKblSc.setString(4, row.get("homeTeam"));
	                insertStmtKblSc.setString(5, row.get("awayTeam"));
	                insertStmtKblSc.addBatch();
	            }
	            insertedKblSc = insertStmtKblSc.executeBatch().length;
	            conn.commit();
	            LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_SC", "SUCCESS",
	                    totalKblSc, insertedKblSc, 0, "", today);
	            LogUtil.insertFlag(today, "colct_sports_match_info_KBL_SC", true); // ‚úÖ Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä
	            System.out.println("‚úÖ KBL_SC ÌÖåÏù¥Î∏î Î∞∞Ïπò ÏÑ±Í≥µ");
	        } catch (SQLException e) {
	            conn.rollback();
	            LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_SC", "FAILED",
	                    totalKblSc, 0, totalKblSc, e.getMessage(), today);
	            System.err.println("‚ùå KBL_SC Î∞∞Ïπò Ïã§Ìå®: " + e.getMessage());
	        }
	        System.out.println("‚úÖ KBL Ïä§ÏºÄÏ§Ñ(Í¥ÄÏ§ëÏ†ïÎ≥¥x) DB Ï†ÄÏû• ÏãúÎèÑ ÏôÑÎ£å");
	        Map<String, LocalDate> result = new HashMap<>();
	        result.put("latestMatchDateColct", LocalDate.parse(latestMatchDateColct, DateTimeFormatter.ofPattern("yyyyMMdd")));
	        result.put("latestMatchDateKblCd", LocalDate.parse(latestMatchDateKblCd, DateTimeFormatter.ofPattern("yyyyMMdd")));
	        return result;

	    } finally {
	        driver.quit();
	    }
	}




    public static Path runCrowdExcelDownload() throws Exception {
        // ‚úÖ ÏûÑÏãú Îã§Ïö¥Î°úÎìú Ìè¥Îçî ÏÉùÏÑ±
        String baseDir = System.getProperty("user.dir");
        String timeTag = DateTimeFormatter.ofPattern("yyyyMMddHHmmss").format(LocalDateTime.now());
        String tempFolderPath = baseDir + File.separator + "kbl_temp_" + timeTag;
        Files.createDirectories(Paths.get(tempFolderPath));

        // ‚úÖ Îã§Ïö¥Î°úÎìú Í≤ΩÎ°ú ÏÑ§Ï†ï
        HashMap<String, Object> prefs = new HashMap<>();
        prefs.put("download.default_directory", tempFolderPath);
        prefs.put("download.prompt_for_download", false);
        prefs.put("profile.default_content_setting_values.automatic_downloads", 1);
        prefs.put("safebrowsing.enabled", true);

        // ‚úÖ ÌÅ¨Î°¨ ÏòµÏÖò ÏÑ§Ï†ï
        System.setProperty("webdriver.chrome.driver", "C:\\chromedriver\\chromedriver.exe");
        ChromeOptions options = new ChromeOptions();
        options.setExperimentalOption("prefs", prefs);
        options.addArguments("--remote-allow-origins=*");

        WebDriver driver = new ChromeDriver(options);
        WebDriverWait wait = new WebDriverWait(driver, java.time.Duration.ofSeconds(15));

        try {
            // ‚úÖ ÏÇ¨Ïù¥Ìä∏ ÏßÑÏûÖ Î∞è Î©îÎâ¥ ÏÑ†ÌÉù
            driver.get("https://kbl.or.kr/record/crowd");
            driver.manage().window().maximize();

            new Select(wait.until(ExpectedConditions.elementToBeClickable(
                    By.cssSelector("#s2iZone > div > ul > li > select")))).selectByValue("team");
            Thread.sleep(1000);
            new Select(wait.until(ExpectedConditions.elementToBeClickable(
                    By.cssSelector("#s2iZone > div > ul > li:nth-child(2) > select")))).selectByValue("00");
            Thread.sleep(1500);

            WebElement excelButton = wait.until(ExpectedConditions.elementToBeClickable(
                    By.cssSelector("#s2iZone > div > div:nth-child(5) > div.mid-title > div > button")));
            excelButton.click();
            System.out.println("üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÌÅ¥Î¶≠ ÏôÑÎ£å");

            // ‚úÖ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÎåÄÍ∏∞
            Path latestXlsx = null;
            for (int i = 0; i < 20; i++) {
                latestXlsx = getLatestXlsxFile(tempFolderPath);
                if (latestXlsx != null) break;
                Thread.sleep(500);
            }

            if (latestXlsx == null || !waitForDownloadComplete(latestXlsx, 10)) {
                System.err.println("‚ùå ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Ïã§Ìå® ÎòêÎäî ÏôÑÎ£åÎêòÏßÄ ÏïäÏùå");
                return null;
            }

            System.out.println("‚úÖ ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú ÏôÑÎ£å: " + latestXlsx);
            return latestXlsx;

        } catch (Exception e) {
            e.printStackTrace();
            return null;
        } finally {
            driver.quit();
        }
    }

    // Í∞ÄÏû• ÏµúÏã† ÏóëÏÖÄ ÌååÏùº Ï∞æÍ∏∞
    private static Path getLatestXlsxFile(String dir) {
        try (Stream<Path> files = Files.list(Paths.get(dir))) {
            return files
                    .filter(p -> p.getFileName().toString().startsWith("ÌåÄ Í¥ÄÏ§ëÌòÑÌô©"))
                    .filter(p -> p.toString().endsWith(".xlsx"))
                    .filter(p -> !p.toString().endsWith(".crdownload"))
                    .max(Comparator.comparing(p -> {
                        try {
                            return Files.getLastModifiedTime(p);
                        } catch (IOException e) {
                            return FileTime.fromMillis(0);
                        }
                    }))
                    .orElse(null);
        } catch (IOException e) {
            return null;
        }
    }

    private static boolean waitForDownloadComplete(Path file, int maxWaitSeconds) {
        try {
            long previousSize = -1;
            for (int i = 0; i < maxWaitSeconds * 2; i++) {
                if (!Files.exists(file)) return false;
                long currentSize = Files.size(file);
                if (currentSize > 0 && currentSize == previousSize) {
                    return true; // ÌÅ¨Í∏∞ Î≥ÄÌôî ÏóÜÏùå ‚Üí ÏôÑÎ£å
                }
                previousSize = currentSize;
                Thread.sleep(500);
            }
        } catch (Exception e) {
            System.out.println("‚ùå waitForDownloadComplete Ïã§Ìå®: " + e.getMessage());
        }
        return false;
    }
    
    public static void updateCrowdFromExcel(Path excelPath, String latestMatchDateCd) throws Exception {
        Workbook workbook = null;
        FileInputStream fis = null;

        try (Connection conn = DriverManager.getConnection(
                "jdbc:mysql://localhost:3306/culture_crawler_db?serverTimezone=Asia/Seoul", "root", "1234")) {

            fis = new FileInputStream(excelPath.toFile());
            workbook = new XSSFWorkbook(fis);

            Sheet sheet = workbook.getSheetAt(0);
            String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
            LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_CD", "STARTED", null, null, null, "", today);

            LocalDate latestDate = LocalDate.parse(latestMatchDateCd, DateTimeFormatter.ofPattern("yyyyMMdd"));

            List<Map<String, String>> dataList = new ArrayList<>();
            List<String> allMatchDeList = new ArrayList<>(); // ‚úÖ Î™®Îì† matchDe ÏàòÏßëÏö©

            for (int i = 1; i <= sheet.getLastRowNum(); i++) {
                Row row = sheet.getRow(i);
                if (row == null) continue;

                String season = getCellString(row, 0);
                String homeRaw = getCellString(row, 1);
                String leagueName = getCellString(row, 2);
                String stadiumName = getCellString(row, 5);
                String rawDate = getCellString(row, 6);
                String rawCrowd = getCellString(row, 7);

                if (!rawDate.matches("\\d{1,2}\\.\\d{1,2}")) continue;

                String[] parts = rawDate.split("\\.");
                int mm = Integer.parseInt(parts[0]);
                int dd = Integer.parseInt(parts[1]);

                int startYear = Integer.parseInt(season.split("-")[0].trim());
                int endYear = Integer.parseInt(season.split("-")[1].trim());
                int year = (mm <= 6) ? endYear : startYear;

                LocalDate matchDate = LocalDate.of(year, mm, dd);
                String matchDe = matchDate.format(DateTimeFormatter.ofPattern("yyyyMMdd"));

                allMatchDeList.add(matchDe); // ‚úÖ ÏàòÏßë

//                if (!matchDate.isAfter(latestDate)) continue;
                if (matchDate.isBefore(latestDate)) continue;
                
                String cleanedCrowd = rawCrowd.replace(",", "").replace("Î™Ö", "").trim();
                if (cleanedCrowd.isEmpty()) continue;

                String homeTeam = normalizeTeamName(extractSecondWordOrOriginal(homeRaw));

                Map<String, String> map = new HashMap<>();
                map.put("matchDe", matchDe);
                map.put("leagueName", leagueName);
                map.put("stadiumName", stadiumName);
                map.put("homeTeam", homeTeam);
                map.put("crowd", cleanedCrowd);
                dataList.add(map);
            }

            // ‚úÖ Ï†ÑÏ≤¥ matchDe Î™©Î°ù Ï∂úÎ†•
            System.out.println("\nüìú ÏóëÏÖÄ ÎÇ¥ Ï∂îÏ∂úÎêú matchDe Ï†ÑÏ≤¥ Î™©Î°ù:");
            allMatchDeList.stream().sorted().forEach(d -> System.out.println(" - " + d));

            // ‚úÖ ÎßàÏßÄÎßâ matchDe Í∏∞Ï§Ä ÎπÑÍµê Ï∂úÎ†•
            Optional<String> maxExcelMatchDe = allMatchDeList.stream().max(Comparator.naturalOrder());
            System.out.println("\nüìå ÏóëÏÖÄ Í∏∞Ï§Ä ÎßàÏßÄÎßâ matchDe: " + maxExcelMatchDe.orElse("ÏóÜÏùå"));
            System.out.println("üìå DB Í∏∞Ï§Ä ÏµúÏã† matchDe(latestMatchDateSc): " + latestMatchDateCd);

            if (maxExcelMatchDe.isPresent()) {
                int cmp = maxExcelMatchDe.get().compareTo(latestMatchDateCd);
                if (cmp > 0) {
                    System.out.println("‚úÖ ÏóëÏÖÄÏùò ÎßàÏßÄÎßâ ÎÇ†ÏßúÍ∞Ä DB Í∏∞Ï§ÄÏùºÎ≥¥Îã§ ÏµúÏã†ÏûÖÎãàÎã§. (ÏÇΩÏûÖ ÎåÄÏÉÅ Ï°¥Ïû¨)");
                } else if (cmp == 0) {
                    System.out.println("‚ö†Ô∏è ÏóëÏÖÄ ÎßàÏßÄÎßâ ÎÇ†ÏßúÍ∞Ä DB Í∏∞Ï§ÄÏùºÍ≥º ÎèôÏùºÌï©ÎãàÎã§. (ÏÇΩÏûÖ Í±¥Ïàò ÏóÜÏùÑ Ïàò ÏûàÏùå)");
                } else {
                    System.out.println("‚ùå ÏóëÏÖÄÏùò ÎßàÏßÄÎßâ ÎÇ†ÏßúÍ∞Ä DB Í∏∞Ï§ÄÏùºÎ≥¥Îã§ Í≥ºÍ±∞ÏûÖÎãàÎã§. (ÏÇΩÏûÖ ÎåÄÏÉÅ ÏóÜÏùå)");
                }
            }

            System.out.println("\nüìã ÌïÑÌÑ∞ÎßÅ ÌõÑ ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ Ïàò(dataList): " + dataList.size());
            for (Map<String, String> row : dataList) {
                System.out.println("üëâ " + row);
            }


            int insertedCount = 0;
            int updatedCount = 0;
            int notUpdatedCount = 0;
            System.out.println("üìã ÌïÑÌÑ∞ÎßÅ ÌõÑ ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ Ïàò: " + dataList.size());
            for (Map<String, String> row : dataList) {
                System.out.println("üëâ " + row);
            }
            // ‚úÖ colct_sports_match_info_KBL_CD ÌÖåÏù¥Î∏î: INSERT
            
            try (PreparedStatement deleteStmt = conn.prepareStatement(
                    "DELETE FROM colct_sports_match_info_KBL_CD WHERE MATCH_DE = ?")) {
                deleteStmt.setString(1, latestMatchDateCd);  // SC ÌÖåÏù¥Î∏î Í∏∞Ï§ÄÏùº
                deleteStmt.executeUpdate();
            }

            try (PreparedStatement insertStmt = conn.prepareStatement("""
                    INSERT INTO colct_sports_match_info_KBL_CD (
                        MATCH_DE, LEA_NM, STDM_NM, HOME_TEAM_NM, SPORTS_VIEWNG_NMPR_CO
                    ) VALUES (?, ?, ?, ?, ?)
                """)) {
                conn.setAutoCommit(false);
                for (Map<String, String> row : dataList) {
                    insertStmt.setString(1, row.get("matchDe"));
                    insertStmt.setString(2, row.get("leagueName"));
                    insertStmt.setString(3, row.get("stadiumName"));
                    insertStmt.setString(4, row.get("homeTeam"));
                    insertStmt.setBigDecimal(5, new BigDecimal(row.get("crowd") + ".00000"));
                    insertStmt.addBatch();
                }
                insertedCount = insertStmt.executeBatch().length;
                conn.commit();

                LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_CD", "SUCCESS",
                        dataList.size(), insertedCount, dataList.size() - insertedCount, "", today);
                LogUtil.insertFlag(today, "colct_sports_match_info_KBL_CD", true); // ‚úÖ Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä
                System.out.println("‚úÖ KBL_CD ÌÖåÏù¥Î∏î Î∞∞Ïπò ÏôÑÎ£å: " + insertedCount + "Í±¥");

            } catch (SQLException e) {
                conn.rollback();
                LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info_KBL_CD", "FAILED",
                        dataList.size(), 0, dataList.size(), e.getMessage(), today);
                System.err.println("‚ùå KBL_CD Î∞∞Ïπò Ïã§Ìå®: " + e.getMessage());
            }

            // ‚úÖ Ï∂îÍ∞ÄÎêú Í≤ΩÍ∏∞ Ïàò ÌôïÏù∏
            int addedGamesCount = 0;
            try (PreparedStatement stmt = conn.prepareStatement(
                    "SELECT COUNT(*) FROM colct_sports_match_info WHERE MATCH_DE > ? AND GRP_NM = 'KBL'")) {
                stmt.setString(1, latestMatchDateCd);
                ResultSet rs = stmt.executeQuery();
                if (rs.next()) {
                    addedGamesCount = rs.getInt(1);
                }
                rs.close();
            }
            System.out.println("üéØ DB ÎÇ¥ ÎßàÏßÄÎßâ Í≤ΩÍ∏∞Ïùº Ïù¥ÌõÑ Ï∂îÍ∞ÄÎêú Í≤ΩÍ∏∞ Ïàò: " + addedGamesCount + "Í±¥");

        } finally {
            if (workbook != null) workbook.close();
            if (fis != null) fis.close();

            try {
                Files.deleteIfExists(excelPath);
                Files.walk(excelPath.getParent())
                    .sorted(Comparator.reverseOrder())
                    .forEach(path -> {
                        try {
                            Files.delete(path);
                        } catch (IOException e) {
                            System.out.println("‚ùå ÏÇ≠Ï†ú Ïã§Ìå®: " + path + " (" + e.getMessage() + ")");
                        }
                    });
                System.out.println("üßπ ÏûÑÏãú Ìè¥Îçî Î∞è ÌååÏùº ÏÇ≠Ï†ú ÏôÑÎ£å");
            } catch (IOException e) {
                System.out.println("‚ùå Ï†ÑÏ≤¥ ÏÇ≠Ï†ú Ïã§Ìå®: " + e.getMessage());
            }
        }
    }
    
    public static void insertToMatchInfoTable(LocalDate baseDate) throws Exception {
        String baseDateStr = baseDate.format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        String today = LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd"));
        LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info", "STARTED", null, null, null, "", today);

        try (Connection conn = DriverManager.getConnection(
                "jdbc:mysql://localhost:3306/culture_crawler_db?serverTimezone=Asia/Seoul", "root", "1234")) {

            // 1. baseDate Ïù¥ÌõÑ Îëê ÌÖåÏù¥Î∏î JOIN
        	String sql = """
        		    SELECT 
        		        sc.MATCH_DE,
        		        sc.LEA_NM,
        		        sc.STDM_NM,
        		        sc.HOME_TEAM_NM,
        		        sc.AWAY_TEAM_NM,
        		        cd.SPORTS_VIEWNG_NMPR_CO
        		    FROM colct_sports_match_info_KBL_SC sc
        		    INNER JOIN colct_sports_match_info_KBL_CD cd
        		        ON sc.MATCH_DE = cd.MATCH_DE AND sc.HOME_TEAM_NM = cd.HOME_TEAM_NM
        		    WHERE sc.MATCH_DE >= ?
        		    ORDER BY sc.MATCH_DE
        		""";


            PreparedStatement stmt = conn.prepareStatement(sql);
            stmt.setString(1, baseDateStr);
            ResultSet rs = stmt.executeQuery();

            List<Map<String, String>> rows = new ArrayList<>();
            while (rs.next()) {
                Map<String, String> row = new HashMap<>();
                String matchDe = rs.getString("MATCH_DE");
                row.put("matchDe", matchDe);
                row.put("baseYear", matchDe.substring(0, 4));
                row.put("baseMonth", matchDe.substring(4, 6));
                row.put("baseDay", matchDe.substring(6, 8));
                row.put("gameType", rs.getString("LEA_NM"));
                row.put("stadium", rs.getString("STDM_NM"));
                row.put("homeTeam", rs.getString("HOME_TEAM_NM"));
                row.put("awayTeam", rs.getString("AWAY_TEAM_NM"));
                row.put("crowd", rs.getString("SPORTS_VIEWNG_NMPR_CO"));
                rows.add(row);
            }

            rs.close();
            stmt.close();

            System.out.println("üìã ÏµúÏ¢Ö ÏÇΩÏûÖÌï† Í±¥Ïàò: " + rows.size());

            // 2. Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú
            try (PreparedStatement deleteStmt = conn.prepareStatement(
                    "DELETE FROM colct_sports_match_info WHERE GRP_NM = 'KBL' AND MATCH_DE = ?")) {
                deleteStmt.setString(1, baseDateStr);
                deleteStmt.executeUpdate();
            }

            // 3. INSERT Ïã§Ìñâ
            try (PreparedStatement insertStmt = conn.prepareStatement("""
                INSERT INTO colct_sports_match_info (
                    MATCH_DE, BASE_YEAR, BASE_MT, BASE_DAY, GRP_NM, LEA_NM, HOME_TEAM_NM, AWAY_TEAM_NM,
                    STDM_NM, SPORTS_VIEWNG_NMPR_CO, COLCT_DE, UPDT_DE
                ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """)) {
                conn.setAutoCommit(false);
                for (Map<String, String> row : rows) {
                    insertStmt.setString(1, row.get("matchDe"));
                    insertStmt.setString(2, row.get("baseYear"));
                    insertStmt.setString(3, row.get("baseMonth"));
                    insertStmt.setString(4, row.get("baseDay"));
                    insertStmt.setString(5, "KBL");
                    insertStmt.setString(6, row.get("gameType"));
                    insertStmt.setString(7, row.get("homeTeam"));
                    insertStmt.setString(8, row.get("awayTeam"));
                    insertStmt.setString(9, row.get("stadium"));

                    if (row.get("crowd") != null) {
                        insertStmt.setBigDecimal(10, new BigDecimal(row.get("crowd")));
                    } else {
                        insertStmt.setNull(10, Types.DECIMAL);
                    }

                    insertStmt.setString(11, today);
                    insertStmt.setString(12, today);
                    insertStmt.addBatch();
                }
                int inserted = insertStmt.executeBatch().length;
                conn.commit();
                LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info", "SUCCESS",
                        rows.size(), inserted, 0, "", today);
                LogUtil.insertFlag(today, "colct_sports_match_info@KBL", true); // ‚úÖ Ïó¨Í∏∞Ïóê Ï∂îÍ∞Ä
                System.out.println("‚úÖ colct_sports_match_info ÏÇΩÏûÖ ÏôÑÎ£å: " + inserted + "Í±¥");

            } catch (SQLException e) {
                conn.rollback();
                LogUtil.insertLog("KBL Ïä§Ìè¨Ï∏† Í¥ÄÎûå", "KBL Ïä§Ìè¨Ï∏† Í≤ΩÍ∏∞ Ï†ïÎ≥¥ ÏàòÏßë", "colct_sports_match_info", "FAILED",
                        rows.size(), 0, 0, e.getMessage(), today);
                System.err.println("‚ùå ÏÇΩÏûÖ Ïã§Ìå®: " + e.getMessage());
            }
        }
    }

    // ‚úÖ Í¥ÄÏ§ëÏàò ÌååÏùºÏö©: Îëê Î≤àÏß∏ Îã®Ïñ¥ Ï∂îÏ∂ú (ÏóÜÏúºÎ©¥ Í∑∏ÎåÄÎ°ú)
    private static String extractSecondWordOrOriginal(String teamName) {
        String[] parts = teamName.trim().split("\\s+");
        return parts.length >= 2 ? parts[1] : parts[0];
    }
    
    private static String getCellString(Row row, int col) {
        if (row == null || row.getCell(col) == null) return "";
        Cell cell = row.getCell(col);
        return switch (cell.getCellType()) {
            case STRING -> cell.getStringCellValue().trim();
            case NUMERIC -> DateUtil.isCellDateFormatted(cell) ?
                    cell.getLocalDateTimeCellValue().toLocalDate().toString() :
                    String.format("%.2f", cell.getNumericCellValue());
            default -> "";
        };
    }

    private static String normalizeTeamName(String teamName) {
        teamName = teamName.trim();
        if (teamName.contains("Ï†ïÍ¥ÄÏû•")) return "KGC";
        if (teamName.contains("Í≥†Ïñë Ï∫êÎ°Ø")) return "Ï∫êÎ°Ø";
        return teamName;
    }

    private static String extractSecond(String name) {
        String[] parts = name.split("\\s+");
        return parts.length >= 2 ? parts[1] : parts[0];
    }

}
